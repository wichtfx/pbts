#!/usr/bin/env python3
"""
Test script for verifying a real TDX quote using dcap-qvl
"""

import sys
import logging

# Setup logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')

# Test quote provided by user
TEST_QUOTE = "040002008100000000000000939a7233f79c4ca9940a0db3957f0607c737391927421f57fb8a2f5f6d9f759600000000060103000000000000000000000000005b38e33a6487958b72c3c12a938eaa5e3fd4510c51aeeab58c7d5ecee41d7c436489d6c8e4f92f160b7cad34207b00c100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000e702060000000000c68518a0ebb42136c12b2275164f8c72f25fa9a34392228687ed6e9caeb9c0f1dbd895e9cf475121c029dc47e70e91fd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000079207fa707c5bbf697d579bbd44c2ba14f8565d528aff0de407c58fd34815b67a35cfbb0a0d996b1c7b911a2c8ae806c154e08f5c1f7b1fce4cbfe1c14f3ba67b70044ede2751487279cd1f2e4239dee99a6d45e24ebde6b6a6f5ae49878e0e69edcd363660e85b71c318324996dda756c372d9f6960edbfa863b1e684822eb48dd95e218ae2b78e51ef97f3b8f5c9dcfd7145f6cfd6ace363058e697a9542ddb7eb86d30a1f4d01a84136b00f12ade3fd63cbc69722c0f2d3e2e209a46edfdc16d0790c1181a43490d3f40ada9eda87c3283e22c6b233456c1f70cfd30c3152cc80db5d45dd72ce0d5a03a5a2a07deba7730b24ea556c8412c68efd695a4174cc1000003a6d229e468dbf83f2f46b04953dfadf65c35916b663c16e7156021c6e6290ca2a03e167bbef1f8c0395584d09efcd4b978e2f7a486bd35c76635be4115f37312f700bfda2a449d6089c2d6c2ace9587ecc6caa2f5b08aa7239f0b00c07d00e84d38a0867754b8269294ef70f9e481512d9b2da65b70f7cafacd1e4dcd333b900600461000000303191b04ff0006000000000000000000000000000000000000000000000000000000000000000000000000000000001500000000000000e700000000000000e5a3a7b5d830c2953b98534c6c59a3a34fdc34e933f7f5898f0a85cf08846bca0000000000000000000000000000000000000000000000000000000000000000dc9e2a7c6f948f17474e34a7fc43ed030f7c1563f1babddf6340c82e0e54a8c5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e0c701cd6b96889f400f042785cd2a1427dd7adeac1e8887b3a2347ac90d29800000000000000000000000000000000000000000000000000000000000000007318a3eb583e75173e453e0e6b0a458d8dcfd34d671d4cfe29f15cdb1597c99521df4b5b2700fd94d0048ce14906d87cdde21480440e6c1ece84ab0b5b4765192000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f05005e0e00002d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d49494538544343424a65674177494241674956414b6d477058726d2f612f777a7a696a58585a71397a67647773356d4d416f4743437147534d343942414d430a4d484178496a416742674e5642414d4d47556c756447567349464e4857434251513073675547786864475a76636d306751304578476a415942674e5642416f4d0a45556c756447567349454e76636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155450a4341774351304578437a414a42674e5642415954416c56544d423458445449314d446b774d54417a4e4449784d316f5844544d794d446b774d54417a4e4449780a4d316f77634445694d434147413155454177775a535735305a5777675530645949464244537942445a584a3061575a70593246305a5445614d426747413155450a43677752535735305a577767513239796347397959585270623234784644415342674e564241634d43314e68626e526849454e7359584a684d517377435159440a5651514944414a445154454c4d416b474131554542684d4356564d775754415442676371686b6a4f5051494242676771686b6a4f50514d4242774e43414152380a424f6c71566330583955544f4870753564485379666e72626f7a6333384c4b67767a65714c304b7a453850543275736b7a5a687a4662726e56424d34693347610a672f59694d344f76502f4e5874446966684430776f3449444444434341776777487759445652306a42426777466f41556c5739647a62306234656c4153636e550a3944504f4156634c336c5177617759445652306642475177596a42676f46366758495a616148523063484d364c79396863476b7564484a316333526c5a484e6c0a636e5a705932567a4c6d6c75644756734c6d4e766253397a5a3367765932567964476c6d61574e6864476c76626939324e4339775932746a636d772f593245390a6347786864475a76636d306d5a57356a62325270626d63395a4756794d42304741315564446751574242524b6c6961753558376f657a7149707a344c6e4577380a2b4a64646654414f42674e56485138424166384542414d434273417744415944565230544151482f4241497741444343416a6b4743537147534962345451454e0a4151534341696f776767496d4d42344743697147534962345451454e41514545454c2b4c3658697564636b2f68693465612b53426a746b776767466a42676f710a686b69472b453042445145434d494942557a415142677371686b69472b4530424451454341514942417a415142677371686b69472b45304244514543416749420a417a415142677371686b69472b4530424451454341774942416a415142677371686b69472b4530424451454342414942416a415142677371686b69472b4530420a44514543425149424244415142677371686b69472b45304244514543426749424154415142677371686b69472b453042445145434277494241444151426773710a686b69472b45304244514543434149424254415142677371686b69472b45304244514543435149424144415142677371686b69472b45304244514543436749420a4144415142677371686b69472b45304244514543437749424144415142677371686b69472b45304244514543444149424144415142677371686b69472b4530420a44514543445149424144415142677371686b69472b45304244514543446749424144415142677371686b69472b453042445145434477494241444151426773710a686b69472b45304244514543454149424144415142677371686b69472b4530424451454345514942437a416642677371686b69472b45304244514543456751510a41774d43416751424141554141414141414141414144415142676f71686b69472b45304244514544424149414144415542676f71686b69472b453042445145450a4241617777473841414141774477594b4b6f5a496876684e4151304242516f424154416542676f71686b69472b453042445145474242412b36397741464b53710a7962304f7033714e397938454d45514743697147534962345451454e415163774e6a415142677371686b69472b45304244514548415145422f7a4151426773710a686b69472b45304244514548416745422f7a415142677371686b69472b45304244514548417745422f7a414b42676771686b6a4f5051514441674e49414442460a41694541774d6857456c6f664d4e34786b2b4d5862465133586d55583056745a44384e5647547830775a54716375494349473265534a475774323248394975500a6e46675377326357396245682b506f6a563452494c583861354277440a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436c6a4343416a32674177494241674956414a567658633239472b487051456e4a3150517a7a674658433935554d416f4743437147534d343942414d430a4d476778476a415942674e5642414d4d45556c756447567349464e4857434251513073675547786864475a76636d306751304578476a415942674e5642416f4d0a45556c756447567349454e76636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155450a4341774351304578437a414a42674e564241674d416b4e424d5173774351594456515148444174545957353059534244624746795954454c4d416b47413155450a4341774351304578437a414a42674e5642415954416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a304441516344516741454e53422f0a377432316c58534f3243757a7078773734654a423732457944476757357258437478327456544c7136684b6b367a2b5569525a436e71523770734f766771466553780a6c6d546c4a6c65546d693257597a33714f42757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f530a6347724442534267555645524d4553304249344b65675261424468644e6f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e5673630a7a526c5a484e6c636e5a705932567a4c6d6c75644756734c6d4e766253397a5a3267765932567964476c6d61574e6864476c76626939324e4339775932746a0a636d772f593245396347786864475a76636d306d5a57356a62325270626d63395a4756794d42304741315564446751574242524b6c696175355837340a657a7149707a344c6e4577382b4a64646654414f42674e56485138424166384542414d434273417744415944565230544151482f4241497741444343416a6b470a43537147534962345451454e4151534341696f776767496d4d42344743697147534962345451454e41514545454c2b4c3658697564636b2f68693465612b530a426a746b776767466a42676f71686b69472b453042445145434d494942557a415142677371686b69472b4530424451454341514942417a415142677371686b69470a2b45304244514543416749424177414251677371686b69472b4530424451454341774942416a415142677371686b69472b4530424451454342414942416a41510a42677371686b69472b45304244514543425149424244415142677371686b69472b45304244514543426749424154415142677371686b69472b453042445145430a4277494241444151426773716869472b45304244514543434149424254415142677371686b69472b45304244514543435149424144415142677371686b69472b450a304244514543436749424144415142677371686b69472b45304244514543437749424144415142677371686b69472b45304244514543444149424144415142670a73716869472b45304244514543445149424144415142677371686b69472b45304244514543446749424144415142677371686b69472b453042445145434477490a42414441516773716869472b45304244514543454149424144415142677371686b69472b4530424451454345514942437a416642677371686b69472b453042440a51454345675151417744436167514241415541414141414141414141444151426771686b69472b45304244514544424149414144415542676f71686b69472b4530420a4451454542416177774738414141415144795948b6f5a496876684e4151304242516f424154416542676f71686b69472b453042445145474242412b36397741460a4b53717962304f7033714e397938454d45514743697147534962345451454e415163774e6a415142677371686b69472b45304244514548415145422f7a41510a42677371686b69472b45304244514548416745422f7a415142677371686b69472b45304244514548417745422f7a414b42676771686b6a4f50515144416749440a5341417752674968414f572f35516b522b533943695344634e6f6f774c7550524c735747662f59693747535839344267775477674169454134a306c72486f4d0a732b586f356f2f7358364f39515778485241765a55474f6452513763767152586171493d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"

# Extract report_data from quote (TDX v4: offset 416, 64 bytes)
def extract_report_data(quote_hex):
    """Extract report_data from TDX quote"""
    quote_bytes = bytes.fromhex(quote_hex)
    if len(quote_bytes) >= 480:  # Minimum size for TDX v4
        report_data_offset = 416
        report_data = quote_bytes[report_data_offset:report_data_offset+64]
        return report_data
    return None

def main():
    print("=" * 80)
    print("TDX Quote Verification Test")
    print("=" * 80)

    # Extract and display report_data
    report_data = extract_report_data(TEST_QUOTE)
    if report_data:
        print(f"\n[INFO] Extracted report_data (64 bytes):")
        print(f"  Hex: {report_data.hex()}")
        print(f"  First 32 bytes (ASCII if printable): {report_data[:32]}")
        # Try to decode as ASCII (if it's text)
        try:
            decoded = report_data.rstrip(b'\x00').decode('ascii')
            print(f"  Decoded (ASCII): '{decoded}'")
            test_payload = decoded
        except:
            print(f"  Note: Not ASCII text, using hex as payload")
            test_payload = report_data.hex()[:20]
    else:
        print("[ERROR] Could not extract report_data - quote too short")
        test_payload = "test_payload"

    print(f"\n[INFO] Using payload for verification: '{test_payload}'")

    # Test with TEE manager
    try:
        from tee_manager import TEEManager, TEEMode, DCAP_QVL_AVAILABLE

        print(f"\n[INFO] DCAP QVL available: {DCAP_QVL_AVAILABLE}")

        if not DCAP_QVL_AVAILABLE:
            print("\n[ERROR] dcap-qvl not installed!")
            print("Install with: pip install dcap-qvl")
            return 1

        # Create manager (TEE mode doesn't matter for verification only)
        print("\n[INFO] Creating TEE manager in DISABLED mode (verification doesn't need TEE)")
        manager = TEEManager(mode=TEEMode.DISABLED)

        # Attempt verification
        print(f"\n[INFO] Verifying quote...")
        print(f"  Quote size: {len(TEST_QUOTE)//2} bytes")
        print(f"  Expected payload: '{test_payload}'")

        try:
            is_valid, duration_ms = manager.verify_attestation(
                quote=TEST_QUOTE,
                expected_payload=test_payload
            )

            print("\n" + "=" * 80)
            print("VERIFICATION RESULT")
            print("=" * 80)
            print(f"  Valid: {is_valid}")
            print(f"  Duration: {duration_ms:.2f} ms")
            print("=" * 80)

            if is_valid:
                print("\n✅ Quote verification PASSED!")
                return 0
            else:
                print("\n❌ Quote verification FAILED!")
                return 1

        except Exception as e:
            print(f"\n[ERROR] Verification failed with exception:")
            print(f"  {type(e).__name__}: {e}")
            import traceback
            traceback.print_exc()
            return 1

    except ImportError as e:
        print(f"\n[ERROR] Import failed: {e}")
        print("Make sure you're in the correct directory and dependencies are installed")
        return 1

if __name__ == "__main__":
    sys.exit(main())
